<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title> Project 1 </title>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }
    
    .data-group text {
      display: none;
      font-size: 0px;
      transition: 1s;
    }
    
    .data-point:hover {
      r: 10px;
      fill: black;
      transition: 1s;
    }
    
    .data-point {
      transition: .5s;
      stroke-width: 1px;
      stroke: black;
    }
    
    .hide {
      display: none;
    }
    
    svg {
      background-color: #fee8c8;
      border: 4px solid black;
    }
    
    .axis path,
    .axis line {
      stroke: black;
      shape-rendering: crispEdges;
    }
    
    .axis text {
      font-family: sans-serif;
      font-weight: bold;
      font-size: 14px;
      fill: black;
    }
    
    .label {
      font-size: 20px;
      font-family: sans-serif;
    }
    
    #filter,
    #sort {
      padding: 10px;
      background-color: lightgreen;
      color: white;
      width: 200px;
      text-align: center;
      font-family: sans-serif;
      margin: 10px auto;
      border: 2px solid darkgreen;
    }
    
    .desc {
      width: 700px;
      margin: 0 auto;
    }

  </style>
</head>

<body>
  <form>
    <label> Min age <input type="number" id="minAge" name="ageMin" min="1" max="100"></label>
    <label> Max age <input type="number" id="maxAge" name="ageMax" min="1" max="100"></label>
    <div id="filter"> Change Age Range </div>
  </form>
  
  <h2> CT Heroin Overdoses: Age of User and Date of Incident </h2>
  <script type="text/javascript">
    //The variable that will hold the data when the csv func runs
    var dataset;

    //used to separate divs
    var barPadding = 1;

    //universal padding used to keep data away from svg edges
    var padding = 50;

    //margin keeps the svg sized appropriately
    var margin = {
      top: 20,
      right: 10,
      bottom: 20,
      left: 10
    };

    //w and h for svg that uses margin
    var w = 800 - margin.left - margin.right;
    var h = 700 - margin.top - margin.bottom;

    //shortcuts for data column names
    var date = "Date";
    var age = "Age";

    //Instantiate global vars (Not necessary now but useful if I have more funcs)
    var xScale = "";
    var yScale = "";
    var xAxis = "";
    var yAxis = "";
    var rScale = "";

    var parseTime = d3.timeParse("%m/%d/%Y");

    //Two functions to move svg elements to front or back as needed
    d3.selection.prototype.moveToFront = function() {
      return this.each(function() {
        this.parentNode.appendChild(this);
      });
    };
    d3.selection.prototype.moveToBack = function() {
      return this.each(function() {
        var firstChild = this.parentNode.firstChild;
        if (firstChild) {
          this.parentNode.insertBefore(this, firstChild);
        }
      });
    };

    //store svg as var. Append to body and set up dimensions.
    var svg = d3.select("body").append("svg")
      .attr("width", w + margin.left + margin.right)
      .attr("height", h + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    //used later, saves space here
    var circles = "";

    var rowConverter = function(d) {
      return {
        Age: d.Age, //No conversion
        Date: parseTime(d.Date)
      };
    }

    //load data file passed in. Generates error if necessary
    d3.csv("./data/CT-Drug-Deaths.csv", rowConverter, function(error, data) {

      if (error) {
        console.log(error);
      } else {
        console.log(data);

        //if data loads correctly then pass it to the global var
        dataset = data;

        //call Funcs
        makeScatter(14, d3.max(dataset, function(d) {
          return d[age]
        }));
      }

    })

    function makeScatter(yMin, yMax) {

      //Scales data to width of canvas
      xScale = d3.scaleTime()
        .domain([
          d3.min(dataset, function(d) {
            //console.log(d.Date);
            return d.Date;
          }),
          d3.max(dataset, function(d) {
            return d.Date;
          })
        ])
        .range([padding, w - padding]);

      //scales data to height of canvas
      yScale = d3.scaleLinear()
        .domain([yMin, yMax])
        .range([h - padding, padding]);

      //Create x and y axis
      xAxis = d3.axisBottom(xScale)
        .ticks(8);

      yAxis = d3.axisLeft(yScale);

      //create circles for each data point
      circles = svg.selectAll("circle")
        .data(dataset)
        .enter()
        .append("g")
        .attr("class", function(d) {
          if (d[age] < yMin || d[age] > yMax)
          {
              return "hide";
          } else {
            return "data-group";
          }
        })
        .append("circle")
        .transition()
        .duration(1000);

      //Make circles
      circles.attr("cx", function(d) {
          return xScale(d.Date);
        })
        .attr("cy", function(d) {
          return yScale(d[age]);
        })
        .attr("r", 6)
        .attr("fill", function(d) {
          var ageStr = d[age].toString(); 
          return "rgb(" + ageStr * 2 + "," + ageStr + "," + ageStr * 4 + ")";
        })
        .attr("class", "data-point")

      //Add tooltip with datum info
      d3.selectAll(".data-group").append("title")
        .text(
          function(d) {
            var day = d[date].getDay();
            var month = d[date].getMonth();
            var year = d[date].getFullYear();

            return "Date of Death: " + month + "/" + day + "/" + year + " | " + "Age: " + d[age];
          });

      //Add hover and click functionality to data
      svg.selectAll(".data-group")
        .on('mouseover', function(d) {
          d3.select(this).moveToFront();
        })
        .on('click', function(d) {
          d3.select(this).moveToBack();
        });

      //AXII
      makeAxii();
    }
    
    function makeAxii() {
      
      //add x-axis
      svg.append("g")
        .transition()
        .duration(1000)
        .attr("class", "axis")
        .attr("transform", "translate(0, " + (h - padding) + ")")
        .call(xAxis);

      //add y-axis
      svg.append("g")
        .transition()
        .duration(1000)
        .attr("class", "axis")
        .attr("transform", "translate(50,0)")
        
        .call(yAxis);

      //Add X-axis label
      svg.append("text")
        .attr("class", "label")
        .text("Date of Death")
        .attr("x", w / 2 - padding)
        .attr("y", h)
        .attr("alignment-baseline", "middle");

      //Add Y-axis label
      svg.append("text")
        .attr("class", "label")
        .text("Age")
        .attr("x", "10")
        .attr("y", h / 2)
        .attr("alignment-baseline", "middle")
        .attr("text-anchor", "middle")
        .attr("transform", "rotate(270, 5," + h / 2 + ")");
    }

    //Get min an max input values and make new scatter plot
    d3.select("#filter")
      .on("click", function() {
        console.log("clicked");

        var minAge = document.getElementById("minAge").value;
        var maxAge = document.getElementById("maxAge").value;
      
        if (minAge > maxAge) {
          alert("min age is bigger than max!");
        } else {
          svg.selectAll("g").remove();
          makeScatter(minAge, maxAge);
        }
      });

  </script>
  <div class="desc">
    <h1> Lucas Kern Project 1</h1>
    <p> Note: The error in parsing dates occured due to me trying to parse each one twice! Realizing that that was all that was stopping the visualization hit me like a sack of bricks! </p>
    <p> Data: I chose a report from data.worldbank.org/data-catalog/ on all of the accidental drug overdoses in Connecticut </p>
    <p> Manipulation: I removed a lot of unecessary columns and used Open Refine to clean the remaining up. I then cleared out all non heroin overdoses using a regular expression which significantly reduced the number of records. </p>
    <p> Chart Type: I went with a scatter plot so I could show the relationship between overdoses and time. And hopefully see a downward trend for all ages but especially on the younger side. You can change the age range to effectively zoom in on parts of the graph. The younger the victim the darker the color of the circle. </p>
    <p> Observations: There was not as much of a correlation as I thought of age and death date. Unfortunately the deaths are fairly consistent over this time period.
    </p>
  </div>
</body>

</html>
