<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title> Kern Project 2 </title>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }
    
    .data-box {
      width: 30%;
      border: 2px solid black;
      color: black;
      margin: 0 auto 20px auto;
      padding: 5px;
    }
    
    #data-box h3,
    #data-box p {
      text-align: left;
      padding: 5px 15px;
    }
    
    .pan rect,
    .zoom rect {
      fill: black;
      opacity: 0.2;
      rx: 15;
      ry: 15;
      transition: 1s;
    }
    
    .zoom rect {
      rx: 5;
      /* Rounded corners */
      ry: 5;
    }
    
    .pan text,
    .zoom text {
      fill: black;
      font-size: 18px;
      text-anchor: middle;
    }
    
    .pan:hover rect,
    .pan:hover text,
    .zoom:hover rect,
    .zoom:hover text {
      fill: green;
      transition: .5s;
    }
  </style>
</head>

<body>
  <h1> Secondary Education <br /> In The United States</h1>

  <script type="text/javascript">
    //universal padding used to keep data away from svg edges
    var padding = 50;

    //margin keeps the svg sized appropriately
    var margin = {
      top: 20,
      right: 10,
      bottom: 20,
      left: 10
    };

    //w and h for svg that uses margin
    var w = 800 - margin.left - margin.right;
    var h = 700 - margin.top - margin.bottom;

    //store svg as var. Append to body and set up dimensions.
    var svg = d3.select("body").append("svg")
      .attr("width", w + margin.left + margin.right)
      .attr("height", h + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var projection = d3.geoAlbersUsa()
      .translate([w / 2, h / 2])
      .scale([1000]);

    var path = d3.geoPath()
      .projection(projection);

    var color = d3.scaleQuantize()
      .range(['rgb(237,248,233)', 'rgb(199,233,192)', 'rgb(161,217,155)', 'rgb(116,196,118)', 'rgb(49,163,84)', 'rgb(0,109,44)'])
      .domain([0, 300]);

    var coordsArr = [];

    //Define what to do when panning or zooming
    var zooming = function(d) {
      //New offset array
      var offset = [d3.event.transform.x, d3.event.transform.y];
      //Calculate new scale
      var newScale = d3.event.transform.k * 2000;
      
      //console.log(newScale);
      
      //Scale school circles
      if (newScale > 9000) {
        if (newScale > 40000) {
          svg.selectAll(".school")
            .transition()
            .duration(1500)
            .style("opacity", 0.75)
            .attr("r", 10);

        } else {
          svg.selectAll(".school")
            .transition()
            .duration(1500)
            .style("opacity", 0.75)
            .attr("r", 3);
        }

      } //Hide if zoomed out 
      else {
        svg.selectAll(".school")
          .transition()
          .duration(500)
          .style("opacity", 0.0);
      }

      //Update projection with new offset and scale
      projection.translate(offset)
        .scale(newScale);
      //Update all paths and circles
      svg.selectAll("path")
        .attr("d", path);

      svg.selectAll("circle")
        .attr("cx", function(d) {
          return projection([d[1], d[2]])[0];
        })
        .attr("cy", function(d) {
          return projection([d[1], d[2]])[1];
        });
    }

    //Then define the zoom behavior
    var zoom = d3.zoom()
      .on("zoom", zooming);

    //The center of the country, roughly
    var center = projection([-127.0, 45.0]);

    //Call first in chain of display/data handling methods
    getCsv();

    function getCsv() {
      d3.csv("./schools.csv", function(data) {

        //console.log(data);

        getJson(data);

      }); //csv data
    }

    function getJson(data) {
      d3.json("us-states.json", function(json) {

        //console.log(json);

        //instantiate value to a number and add coords array to each state;
        for (var j = 0; j < json.features.length; j++) {
          json.features[j].properties.value = 0;
          json.features[j].properties.coords = [];
        }

        //When csv and json match add to state total and add a coord entry
        for (var i = 0; i < data.length; i++) {

          //state name
          var dataState = data[i].STABBR;

          //corresponding state in geo
          for (var j = 0; j < json.features.length; j++) {
            var jsonState = json.features[j].properties.name;

            if (dataState == jsonState) {
              //increase num of inst for state
              var jsonStateCurr = parseInt(json.features[j].properties.value);
              var jsonStateNew = jsonStateCurr + 1;
              var jsonStateString = jsonStateNew.toString();
              json.features[j].properties.value = jsonStateString;

              //add a coord
              var coords = json.features[j].properties.coords;

              //Stop coord adding to keep program from crashing
              if (coordsArr.length < 3300) {
                coordsArr.push([data[i].STABBR, data[i].LONGITUD, data[i].LATITUDE, data[i].INSTNM, data[i].ADDR, data[i].CITY, data[i].WEBADDR]);
              }

              break;
            }
          }
        }

        console.log(json);
        //console.log(coordsArr);

        drawMap(json);

      }); // geoJson
    }

    function drawMap(json) {
      //svg.select("")

      //Draw map and fill according to value
      svg.selectAll("path")
        .data(json.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("class", "state")
        .style("fill", function(d) {
          //get data value
          var value = d.properties.value;

          if (value) {
            //if value exists
            return color(value);
          } else {
            //return grey if doesnt exist
            return "#ccc";
          }
        })
        .style("stroke", "black")
        .style("stroke-width", "0.5")
        .append("title") //Simple tooltip
        .text(function(d) {
          //console.log(d.properties);
          return d.properties.name + ": " + d.properties.value + " Secondary Education Institutions";
        });

      //Add school spots
      appendCircles();
    }

    function appendCircles() {
      //debugger;

      //Create a container in which all zoom-able elements will live
      var map = svg.append("g")
        .attr("id", "map")
        .call(zoom) //Bind the zoom behavior
        .call(zoom.transform, d3.zoomIdentity //Then apply the initial transform
          .translate(w / 2, h / 2)
          .scale(0.5)
          .translate(-center[0], -center[1]));

      //Create a new, invisible background rect to catch zoom events
      map.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", w)
        .attr("height", h)
        .attr("opacity", 0);

      //console.log(coordsArr);

      //do this once for each coord spot of that state
      svg.selectAll("circle")
        .data(coordsArr)
        .enter()
        .append("circle")
        .attr("cx", function(d) {
          var state = d[0].toString();
          var long = parseFloat(d[1]);
          var lat = parseFloat(d[2]);

          //console.log(state + ": long: " + long  + ", " + lat );

          return projection([long, lat])[0];

        })
        .attr("cy", function(d) {
          var state = d[0].toString();
          var long = parseFloat(d[1]);
          var lat = parseFloat(d[2]);

          //console.log(state + ": long: " + long  + ", " + lat );

          return projection([long, lat])[1];
        })
        .attr("r", 1)
        .attr("class", "school")
        .style("fill", "#ffbb3d")
        .style("opacity", 0.0)
        .on("click", function(d) {
          click(d);
        });

      //debugger;
    }

    function click(d) {
      var abbr = d[0];
      var schoolTitle = d[3];
      var addr = d[4];
      var city = d[5];
      var url = d[6];

      document.getElementById("school-name").innerHTML = "Institution: <br/> " + schoolTitle;
      document.getElementById("school-addr").innerHTML = "Address: " + addr + ", " + city + " " + abbr ;
      document.getElementById("school-link").innerHTML = "URL: <a href='" + url + "'> " + url + "</a>";
    }

    function createPanButtons() {
      var north = svg.append("g")
        .attr("class", "pan") //All share the 'pan' class
        .attr("id", "north"); //The ID will tell us which direction to head
      north.append("rect")
        .attr("x", w / 2 - 50)
        .attr("y", 0)
        .attr("width", 100)
        .attr("height", 30);
      north.append("text")
        .attr("x", w / 2)
        .attr("y", 20)
        .html("&uarr;");

      //South
      var south = svg.append("g")
        .attr("class", "pan")
        .attr("id", "south");
      south.append("rect")
        .attr("x", w / 2 - 50)
        .attr("y", h - 30)
        .attr("width", 100)
        .attr("height", 30);
      south.append("text")
        .attr("x", w / 2)
        .attr("y", h - 10)
        .html("&darr;");

      //West
      var west = svg.append("g")
        .attr("class", "pan")
        .attr("id", "west");
      west.append("rect")
        .attr("x", 0)
        .attr("y", h / 2 - 50)
        .attr("width", 30)
        .attr("height", 100);
      west.append("text")
        .attr("x", 15)
        .attr("y", h / 2)
        .html("&larr;");

      //East
      var east = svg.append("g")
        .attr("class", "pan")
        .attr("id", "east");
      east.append("rect")
        .attr("x", w - 30)
        .attr("y", h / 2 - 50)
        .attr("width", 30)
        .attr("height", 100);
      east.append("text")
        .attr("x", w - 15)
        .attr("y", h / 2)
        .html("&rarr;");

      //Panning interaction
      d3.selectAll(".pan")
        .on("click", function() {

          //Get current translation offset
          var offset = projection.translate();
          //Set how much to move on each click
          var moveAmount = 50;

          //Which way are we headed?
          var direction = d3.select(this).attr("id");
          //Modify the offset, depending on the direction
          switch (direction) {
            case "north":
              offset[1] += moveAmount; //Increase y offset
              break;
            case "south":
              offset[1] -= moveAmount; //Decrease y offset
              break;
            case "west":
              offset[0] += moveAmount; //Increase x offset
              break;
            case "east":
              offset[0] -= moveAmount; //Decrease x offset
              break;
            default:
              break;
          }

          //Update projection with new offset
          projection.translate(offset);
          //Update all paths and circles
          svg.selectAll("path")
            .attr("d", path);

          svg.selectAll("circle")
            .attr("cx", function(d) {
              return projection([d[1], d[2]])[0];
            })
            .attr("cy", function(d) {
              return projection([d[1], d[2]])[1];
            });

        });
    }

    //Create zoom buttons
    var createZoomButtons = function() {
      //Create the clickable groups
      //Zoom in button
      var zoomIn = svg.append("g")
        .attr("class", "zoom") //All share the 'zoom' class
        .attr("id", "in") //The ID will tell us which direction to head
        .attr("transform", "translate(" + (w - 110) + "," + (h - 70) + ")");
      zoomIn.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", 30)
        .attr("height", 30);
      zoomIn.append("text")
        .attr("x", 15)
        .attr("y", 20)
        .text("+");

      //Zoom out button
      var zoomOut = svg.append("g")
        .attr("class", "zoom")
        .attr("id", "out")
        .attr("transform", "translate(" + (w - 70) + "," + (h - 70) + ")");
      zoomOut.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", 30)
        .attr("height", 30);
      zoomOut.append("text")
        .attr("x", 15)
        .attr("y", 20)
        .html("&ndash;");
      //Zooming interaction
      d3.selectAll(".zoom")
        .on("click", function() {
          //Set how much to scale on each click
          var scaleFactor;

          //Which way are we headed?
          var direction = d3.select(this).attr("id");
          //Modify the k scale value, depending on the direction
          switch (direction) {
            case "in":
              scaleFactor = 1.5;
              break;
            case "out":
              scaleFactor = 0.75;
              break;
            default:
              break;
          }
          //This triggers a zoom event, scaling by 'scaleFactor'
          map.transition()
            .call(zoom.scaleBy, scaleFactor);
        });
    }
  </script>

  <div class="data-box">
    <h2> Click a point to get school info </h2>
    <h4 id="school-name"> School Name: </h4>
    <p id="school-link"> URL: </p>
    <p id="school-addr"> Address: </p>
  </div>

  <div class="data-box">
    <p> Visualized the number of higher ed institutions in each state. Darker color = more schools. Zoom in to view individual school and access data for them. The zooming/dragging functionality got in the way of being able to mouseover each state for information about each as a whole. </p>
    
    <p> Data was from data.gov, I deleted a lot of columns. changed state vals in the json to abbreviations </p>
    
    <p> I spent in excess of 5 hours trying to work out an issue where I was not able to display all the schools on the map. I still dont really know what was happening there was some very strange behavior going on but the best answer I have is that d3 or svg simply poops itself when there are more than 3400 elements in an array being processed. I also tried to add a different view that showed the states with their size representing how many school they had. I could get that sort of working but I couldnt get them to be in the same place, they scaled and were moved by the scale value. </p> 
    
    <p> Given more time I would definitely try to get the states compared in some way, maybe just rank them in a list and show their values. Also incorporate the population file to filter inst per population. </p>
  </div>
  
</body>

</html>
